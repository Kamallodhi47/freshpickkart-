package com.univ.controller;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.util.Arrays;
import java.util.List;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.util.ObjectUtils;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.multipart.MultipartFile;
import com.univ.entity.UserDtls;
import com.univ.service.Sellerservice;
import com.univ.service.UserDtlsService;
import com.univ.Repository.UserDtlsRepository;
import com.univ.entity.Category;
import com.univ.entity.Product;
import com.univ.entity.Seller;

import jakarta.servlet.http.HttpSession;

@Controller
public class User1controller {
	@Autowired
	public UserDtlsService userDtlsService;
	@Autowired
	 private Sellerservice sellerservice;
	
	@Autowired
	private RestTemplate restTemplate;

	@GetMapping("/")
	public String index(Model model) {
		List<Category> categories = userDtlsService.getCategoriesFromAdmin().stream()
				.sorted((c1, c2) -> c2.getId().compareTo(c1.getId())).limit(6).toList();
		model.addAttribute("categories", categories);
		
	
	    List<Product> products = userDtlsService.getProductsFromAdmin().stream() 
	    		.sorted((p1, p2) -> p2.getId().compareTo(p1.getId())).limit(8).toList();// ye method create karna hoga
	    model.addAttribute("products", products);
		return "Index"; // index.jsp
	}
  @RequestMapping("sel")
	public String Sel()
	{
	return"Seller";
	}
	@RequestMapping("register")
	public String Ragistretion() {
		return "register";
	}
	/*
	 * @RequestMapping("sel") public String Sellar() { return"Sellar"; }
	 */

	@RequestMapping("Login")
	public String Login() {
		return "Login";
	}

	@RequestMapping("Das")
	public String Dasbord() {
		return "Dasbord";
	}
	
	

	@RequestMapping("products")
	public String product(Model model) {
		List<Category> categories = userDtlsService.getCategoriesFromAdmin();
		
		model.addAttribute("categories", categories);
		
		 List<Product> products = userDtlsService.getProductsFromAdmin();  // ye method create karna hoga
		    model.addAttribute("products", products);
		
		return "product";
	}

	///////////////////////////////////////////////////////////////////////////////////
	// registter
	/*
	 * @PostMapping("saveUser") public String Register(@ModelAttribute UserDtls
	 * User, @RequestParam("img") MultipartFile file, HttpSession session) throws
	 * IOException { Boolean existsEmail =
	 * userDtlsService.existsEmail(User.getEmail()); if (existsEmail) {
	 * session.setAttribute("errorMsg", "Email already exist"); } else { String
	 * imageName = file.isEmpty() ? "default.jpg" : file.getOriginalFilename();
	 * User.setProfileImage(imageName);
	 * 
	 * UserDtls saveUser = userDtlsService.saveUserDtls(User);
	 * 
	 * if (!ObjectUtils.isEmpty(saveUser)) { if (!file.isEmpty()) { String uploadDir
	 * =
	 * "C:\\ProjectWebccg\\User1\\User1\\src\\main\\webapp\\assets\\img\\profile_img";
	 * 
	 * Path path = Paths.get(uploadDir, file.getOriginalFilename()); //
	 * System.out.println(path); Files.copy(file.getInputStream(), path,
	 * StandardCopyOption.REPLACE_EXISTING); // Files.copy(file.getInputStream(),
	 * path, StandardCopyOption.REPLACE_EXISTING);
	 * 
	 * } session.setAttribute("succMsg", "Register successfully"); }
	 * 
	 * else { session.setAttribute("errorMsg", "something wrong on server"); }
	 * 
	 * }
	 * 
	 * return "redirect:/Login"; }
	 */
	
	
	////////////////////////////////////////////
	
	/*
	 * @Controller public class UserController {
	 */

		/*
		 * @Autowired private UserRepository userRepo
		 */;

		@PostMapping("/saveUser")
		public String registerUser(@ModelAttribute UserDtls user,
		                           @RequestParam("img") MultipartFile file,
		                           HttpSession session) {

			try {
				// Password encryption (optional)
				// user.setPassword(new BCryptPasswordEncoder().encode(user.getPassword()));

				String role = user.getRole();
				userDtlsService.existsEmail(user.getEmail());
				if ("USER".equalsIgnoreCase(role)) {
					user.setIsEnable(true); // direct enable for user
				} else if ("SELLER".equalsIgnoreCase(role)) {
					user.setIsEnable(false); // seller needs admin approval
				}

				// Save user image (optional)
				if (!file.isEmpty()) {
					/* user.setProfileImage(file.getOriginalFilename()); */
					if (!file.isEmpty()) {
					    String uploadDir = "C:\\ProjectWebccg\\User1\\User1\\src\\main\\webapp\\assets\\img\\profile_img";
					    Path path = Paths.get(uploadDir, file.getOriginalFilename());
					    Files.copy(file.getInputStream(), path, StandardCopyOption.REPLACE_EXISTING);
					}
					// file transfer logic here
				}

				/*
				 * UserDtlsService service = new UserDtlsService(); service.save(user);
				 */
				userDtlsService.save(user);

				if ("USER".equalsIgnoreCase(role)) {
					session.setAttribute("msg", "User registered successfully! Please login.");
					return "redirect:/Login";
				} else if ("SELLER".equalsIgnoreCase(role)) {
					session.setAttribute("msg", "Seller registration sent for admin approval!");
					return "redirect:/pendingApproval";
				}

			} catch (Exception e) {
				e.printStackTrace();
				session.setAttribute("msg", "Error occurred during registration.");
			}
			return "redirect:/register";
		}
	
		/*
		 * @PostMapping("/loginUser") public String loginUser(@RequestParam String
		 * email,
		 * 
		 * @RequestParam String password, HttpSession session) {
		 * 
		 * UserDtls user = userDtlsService.findByEmail(email);
		 * 
		 * 
		 * if (user == null || !user.getPassword().equals(password)) {
		 * session.setAttribute("msg", "Invalid email or password!"); }
		 * 
		 * if (!user.getIsEnable()) { session.setAttribute("msg",
		 * "Account not active. Wait for admin approval!"); }
		 * 
		 * 
		 * session.setAttribute("user", user);
		 * 
		 * switch (user.getRole().toUpperCase()) {
		 * 
		 * case "ADMIN": return "redirect://localhost:8080/index"; case "SELLER": return
		 * "redirect://localhost:8082/index"; default: return "redirect:Index";
		 * 
		 * 
		 * }
		 * 
		 * }
		 */
		
		@PostMapping("/loginUser")
		public String loginUser(@RequestParam String email,
		                        @RequestParam String password,
		                        HttpSession session) {

		    UserDtls user = userDtlsService.findByEmail(email);

		    // NULL CHECK
		    if (user == null) {
		        session.setAttribute("msg", "Invalid email!");
		        return "redirect:/Login";
		    }

		    // PASSWORD CHECK
		    if (!user.getPassword().equals(password)) {
		        session.setAttribute("msg", "Wrong password!");
		        return "redirect:/Login";
		    }

		    // ENABLE CHECK
		    if (!user.getIsEnable()) {
		        session.setAttribute("msg", "Account not active. Wait for admin approval.");
		        return "redirect:/Login";
		    }
		    
		    else {
		    	
		    	return"Index";
		    }

		    // SET USER IN SESSION
		   // session.setAttribute("user", user);

		    // ROLE CHECK
			/*
			 * switch (user.getRole().toUpperCase()) { case "ADMIN": return
			 * "redirect://localhost:8080/index"; case "SELLER": return
			 * "redirect://localhost:8082/index"; default: return "redirect:/"; }
			 */
		}

				
}
